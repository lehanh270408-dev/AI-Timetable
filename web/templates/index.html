{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block content %}

<!-- KPI Cards -->
<div class="grid-4" style="margin-bottom:20px;">
  <div class="card">
    <h4 style="margin:0 0 8px 0; font-size:13px; color:var(--muted);">Tổng số lớp</h4>
    <div class="value" id="stat-total-classes" style="font-size:28px; font-weight:700; color:#2563eb;">-</div>
  </div>
  <div class="card">
    <h4 style="margin:0 0 8px 0; font-size:13px; color:var(--muted);">Số phòng sử dụng</h4>
    <div class="value" id="stat-total-rooms" style="font-size:28px; font-weight:700; color:#059669;">-</div>
  </div>
  <div class="card">
    <h4 style="margin:0 0 8px 0; font-size:13px; color:var(--muted);">Số môn học</h4>
    <div class="value" id="stat-total-courses" style="font-size:28px; font-weight:700; color:#dc2626;">-</div>
  </div>
  <div class="card">
    <h4 style="margin:0 0 8px 0; font-size:13px; color:var(--muted);">Tỉ lệ lấp đầy</h4>
    <div class="value" id="stat-fill-rate" style="font-size:28px; font-weight:700; color:#ea580c;">-</div>
  </div>
</div>

<!-- Lịch hôm nay (cá nhân) -->
<div class="panel" style="margin-bottom:20px;">
  <h3 style="margin:0 0 16px 0;">Lịch hôm nay (cá nhân)</h3>
  <div id="today-schedule" style="display:grid; gap:8px;"></div>
  <p id="today-note" style="color:var(--muted); margin-top:8px; font-size:12px;"></p>
</div>

<!-- Tổng quan tuần (cá nhân) -->
<div class="panel" style="margin-bottom:20px;">
  <h3 style="margin:0 0 16px 0;">Tổng quan tuần (cá nhân)</h3>
  <div id="weekly-summary" style="display:flex; gap:12px; flex-wrap:wrap;"></div>
</div>

<!-- Quick Actions -->
<div class="panel" style="margin-bottom:20px;">
  <h3 style="margin:0 0 16px 0;">Thao tác nhanh</h3>
  <div style="display:flex; gap:12px; flex-wrap:wrap;">
    <button class="btn" id="btnRunSchedule" style="padding:16px 24px; font-size:16px;">
      <i class="bi bi-cpu" style="margin-right:8px;"></i>Chạy sắp xếp TKB
    </button>
    <button class="btn secondary" id="btnRunRecommend" style="padding:16px 24px; font-size:16px;">
      <i class="bi bi-magic" style="margin-right:8px;"></i>Chạy gợi ý lớp
    </button>
    <button class="btn secondary" id="btnRunRecommendSchedule" style="padding:16px 24px; font-size:16px;">
      <i class="bi bi-calendar2-check" style="margin-right:8px;"></i>Tạo TKB gợi ý
    </button>
  </div>
  
  <!-- Job Status (chỉ hiện khi có job) -->
  <div id="job-section" style="display:none; margin-top:16px; padding-top:16px; border-top:1px solid var(--border);">
    <div style="display:grid; gap:8px;">
      <label for="jobId">Job ID</label>
      <div style="display:flex; gap:8px;">
        <input id="jobId" placeholder="Dán job_id" style="flex:1;" />
        <button class="btn secondary" id="btnPoll">Poll</button>
      </div>
      <div id="jobStatus" style="background:var(--panel); padding:12px; max-height:400px; overflow:auto;"></div>
    </div>
  </div>
</div>

<!-- Top Recommendations -->
<div class="panel" style="margin-bottom:20px;">
  <h3 style="margin:0 0 16px 0;">Top gợi ý AI</h3>
  <div id="top-recommendations" style="display:grid; gap:8px;">
    <p style="color:var(--muted); font-size:14px;">Đang tải...</p>
  </div>
</div>

<!-- Quick Links -->
<div class="panel">
  <h3 style="margin:0 0 16px 0;">Xem thời khoá biểu</h3>
  <div style="display:flex; gap:12px; flex-wrap:wrap;">
    <a class="btn secondary" href="/timetable/school" style="padding:12px 20px;">
      <i class="bi bi-building" style="margin-right:8px;"></i>TKB Toàn trường
    </a>
    <a class="btn secondary" href="/timetable/student" style="padding:12px 20px;">
      <i class="bi bi-person" style="margin-right:8px;"></i>TKB Cá nhân (Học sinh)
    </a>
    <a class="btn secondary" href="/timetable/teacher" style="padding:12px 20px;">
      <i class="bi bi-person-badge" style="margin-right:8px;"></i>TKB Cá nhân (Giáo viên)
    </a>
  </div>
</div>

<script>
  // Load stats
  async function loadStats() {
    try {
      const res = await fetch('/api/stats');
      const stats = await res.json();
      
      // Update KPI cards
      document.getElementById('stat-total-classes').textContent = stats.total_classes || 0;
      document.getElementById('stat-total-rooms').textContent = stats.total_rooms || 0;
      document.getElementById('stat-total-courses').textContent = stats.total_courses || 0;
      
      // Fill rate
      const fillRate = stats.total_slots > 0 ? 
        Math.round((stats.filled_slots / stats.total_slots) * 100) : 0;
      document.getElementById('stat-fill-rate').textContent = fillRate + '%';
      
      // Personal stats (today + week)
      try {
        const resP = await fetch('/api/personal_stats');
        const ps = await resP.json();
        const todayWrap = document.getElementById('today-schedule');
        const todayNote = document.getElementById('today-note');
        const daysOrder = ['Mon','Tue','Wed','Thu','Fri','Sat'];
        const dayNames = {'Mon': 'Thứ 2', 'Tue': 'Thứ 3', 'Wed': 'Thứ 4', 'Thu': 'Thứ 5', 'Fri': 'Thứ 6', 'Sat': 'Thứ 7'};

        // Hôm nay
        if (ps.has_data && ps.today && ps.today.length) {
          todayWrap.innerHTML = ps.today.map(item => `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:10px; border:1px solid var(--border); background:var(--panel); border-radius:8px;">
              <div style="font-weight:700; color:#1e40af; min-width:90px;">${item.time}</div>
              <div style="flex:1; padding:0 8px;">${item.subject || ''}</div>
              <div style="color:var(--muted); min-width:80px; text-align:right;">${item.room || ''}</div>
            </div>
          `).join('');
          todayNote.textContent = `Nguồn dữ liệu: ${ps.source}`;
        } else {
          todayWrap.innerHTML = '<p style="color:var(--muted);">Hôm nay không có lớp.</p>';
          todayNote.textContent = ps.source ? `Nguồn dữ liệu: ${ps.source}` : '';
        }

        // Tuần này (đếm theo ngày)
        const weekWrap = document.getElementById('weekly-summary');
        if (ps.has_data && ps.counts_by_day) {
          weekWrap.innerHTML = daysOrder.map(d => {
            const cnt = ps.counts_by_day[d] || 0;
            return `
              <div title="${dayNames[d]}: ${cnt} lớp" style="min-width:120px; padding:12px; border:1px solid var(--border); border-radius:8px; background:var(--panel); display:flex; flex-direction:column; align-items:center;">
                <div style="font-size:12px; color:var(--muted);">${dayNames[d]}</div>
                <div style="font-size:22px; font-weight:800; color:#2563eb;">${cnt}</div>
              </div>
            `;
          }).join('');
        } else {
          weekWrap.innerHTML = '<p style="color:var(--muted);">Chưa có dữ liệu cá nhân.</p>';
        }
      } catch (e) {
        console.error('Lỗi tải personal stats', e);
      }
      
      // Top recommendations
      const recContainer = document.getElementById('top-recommendations');
      if (stats.top_recommendations && stats.top_recommendations.length > 0) {
        recContainer.innerHTML = stats.top_recommendations.map((rec, idx) => `
          <div style="display:flex; align-items:center; justify-content:space-between; padding:10px; background:var(--panel); border-radius:8px; border:1px solid var(--border);">
            <div style="flex:1;">
              <div style="font-weight:600; color:var(--text);">${rec.course} - ${rec.subject}</div>
              <div style="font-size:12px; color:var(--muted); margin-top:2px;">Điểm AI: ${rec.score.toFixed(2)}</div>
            </div>
            <div style="background:#10b981; color:white; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:600;">
              #${idx + 1}
            </div>
          </div>
        `).join('');
      } else {
        recContainer.innerHTML = '<p style="color:var(--muted); font-size:14px;">Chưa có dữ liệu gợi ý. Hãy chạy "Chạy gợi ý lớp" để xem.</p>';
      }
    } catch (e) {
      console.error('Lỗi tải stats:', e);
    }
  }

  // Job management
  async function post(url) {
    const res = await fetch(url, { method: 'POST' });
    if (!res.ok) throw new Error('Request failed');
    return await res.json();
  }

  async function get(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error('Request failed');
    return await res.json();
  }

  const btnRunSchedule = document.getElementById('btnRunSchedule');
  const btnRunRecommend = document.getElementById('btnRunRecommend');
  const btnRunRecommendSchedule = document.getElementById('btnRunRecommendSchedule');
  const jobIdInput = document.getElementById('jobId');
  const jobStatus = document.getElementById('jobStatus');
  const btnPoll = document.getElementById('btnPoll');
  const jobSection = document.getElementById('job-section');

  btnRunSchedule.addEventListener('click', async () => {
    btnRunSchedule.setAttribute('aria-busy', 'true');
    try {
      const data = await post('/run/schedule');
      jobIdInput.value = data.job_id;
      jobSection.style.display = 'block';
      await poll(data.job_id);
    } catch (e) {
      alert('Lỗi chạy sắp xếp');
    } finally {
      btnRunSchedule.removeAttribute('aria-busy');
    }
  });

  btnRunRecommend.addEventListener('click', async () => {
    btnRunRecommend.setAttribute('aria-busy', 'true');
    try {
      const data = await post(`/run/recommend`);
      jobIdInput.value = data.job_id;
      jobSection.style.display = 'block';
      await poll(data.job_id);
    } catch (e) {
      alert('Lỗi chạy gợi ý');
    } finally {
      btnRunRecommend.removeAttribute('aria-busy');
    }
  });

  btnRunRecommendSchedule.addEventListener('click', async () => {
    btnRunRecommendSchedule.setAttribute('aria-busy', 'true');
    try {
      const data = await post('/run/recommend_schedule');
      jobIdInput.value = data.job_id;
      jobSection.style.display = 'block';
      await poll(data.job_id);
    } catch (e) {
      alert('Lỗi tạo TKB gợi ý');
    } finally {
      btnRunRecommendSchedule.removeAttribute('aria-busy');
    }
  });

  btnPoll.addEventListener('click', async () => {
    const id = jobIdInput.value.trim();
    if (!id) return;
    jobSection.style.display = 'block';
    await poll(id);
  });

  function formatJobStatus(job) {
    if (!job) return '<p style="color:var(--muted);">Đang tải...</p>';
    
    const status = job.status || 'unknown';
    const statusColors = {
      'running': '#3b82f6',
      'completed': '#10b981',
      'failed': '#ef4444',
      'unknown': '#6b7280'
    };
    const statusTexts = {
      'running': 'Đang chạy',
      'completed': 'Hoàn thành',
      'failed': 'Thất bại',
      'unknown': 'Không xác định'
    };
    
    let html = `
      <div style="display:grid; gap:12px;">
        <div style="display:flex; align-items:center; gap:8px; padding:8px; background:var(--bg); border-radius:6px;">
          <div style="width:12px; height:12px; border-radius:50%; background:${statusColors[status] || statusColors.unknown};"></div>
          <strong>Trạng thái:</strong> <span style="color:${statusColors[status] || statusColors.unknown};">${statusTexts[status] || status}</span>
        </div>
    `;
    
    if (job.title) {
      html += `<div><strong>Tiêu đề:</strong> ${job.title}</div>`;
    }
    
    if (job.created_at) {
      const date = new Date(job.created_at);
      html += `<div><strong>Thời gian tạo:</strong> ${date.toLocaleString('vi-VN')}</div>`;
    }
    
    // Phân tích logs
    if (job.logs && job.logs.length > 0) {
      html += `<div style="margin-top:8px;"><strong>Thông báo:</strong></div>`;
      html += `<table style="width:100%; border-collapse:collapse; margin-top:8px;">`;
      html += `<thead><tr style="background:var(--bg); border-bottom:1px solid var(--border);"><th style="padding:8px; text-align:left; width:100px;">Loại</th><th style="padding:8px; text-align:left;">Nội dung</th></tr></thead>`;
      html += `<tbody>`;
      
      const successLogs = [];
      const errorLogs = [];
      const warningLogs = [];
      const infoLogs = [];
      
      job.logs.forEach(log => {
        const logStr = String(log);
        if (logStr.includes('[SUCCESS]') || logStr.includes('[SUCCESS]')) {
          successLogs.push(logStr.replace(/\[SUCCESS\]/g, '').trim());
        } else if (logStr.includes('[ERROR]') || logStr.includes('[ERROR]')) {
          errorLogs.push(logStr.replace(/\[ERROR\]/g, '').trim());
        } else if (logStr.includes('[WARNING]') || logStr.includes('[WARNING]')) {
          warningLogs.push(logStr.replace(/\[WARNING\]/g, '').trim());
        } else if (logStr.includes('[INFO]') || logStr.includes('[INFO]')) {
          infoLogs.push(logStr.replace(/\[INFO\]/g, '').trim());
        } else {
          infoLogs.push(logStr.trim());
        }
      });
      
      successLogs.forEach(msg => {
        html += `<tr><td style="padding:6px 8px; color:#10b981; font-weight:600;">Thành công</td><td style="padding:6px 8px;">${msg}</td></tr>`;
      });
      
      warningLogs.forEach(msg => {
        html += `<tr><td style="padding:6px 8px; color:#f59e0b; font-weight:600;">Cảnh báo</td><td style="padding:6px 8px;">${msg}</td></tr>`;
      });
      
      errorLogs.forEach(msg => {
        html += `<tr><td style="padding:6px 8px; color:#ef4444; font-weight:600;">Lỗi</td><td style="padding:6px 8px;">${msg}</td></tr>`;
      });
      
      infoLogs.forEach(msg => {
        if (msg) html += `<tr><td style="padding:6px 8px; color:var(--muted);">Thông tin</td><td style="padding:6px 8px;">${msg}</td></tr>`;
      });
      
      html += `</tbody></table>`;
    }
    
    if (job.error) {
      html += `<div style="margin-top:12px; padding:12px; background:#fee2e2; border:1px solid #fecaca; border-radius:6px; color:#991b1b;"><strong>Lỗi:</strong> ${job.error}</div>`;
    }
    
    if (job.result) {
      const returncode = job.result.returncode;
      if (returncode !== undefined) {
        const codeColor = returncode === 0 ? '#10b981' : '#ef4444';
        html += `<div style="margin-top:8px;"><strong>Mã trả về:</strong> <span style="color:${codeColor};">${returncode}</span></div>`;
      }
    }
    
    html += `</div>`;
    return html;
  }

  async function poll(id) {
    jobStatus.innerHTML = '<p style="color:var(--muted);">Đang kiểm tra...</p>';
    let stop = false;
    while (!stop) {
      const s = await get(`/status/${id}`);
      jobStatus.innerHTML = formatJobStatus(s);
      if (s.status === 'completed' || s.status === 'failed') {
        stop = true;
        // Reload stats sau khi job hoàn thành
        if (s.status === 'completed') {
          setTimeout(loadStats, 1000);
        }
      }
      else await new Promise(r => setTimeout(r, 1500));
    }
  }

  // Load stats khi trang load
  loadStats();
</script>
{% endblock %}
